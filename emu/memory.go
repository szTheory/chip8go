package emu

import (
	"io/ioutil"
)

type Memory struct {
	// 4KB (4,096 bytes) from 0x000 (0) to 0xFFF (4095)
	// the uppermost 256 bytes (0xF00-0xFFF) are reserved for display refresh,
	// and the 96 bytes below that (0xEA0-0xEFF) are reserved for the call stack,
	// internal use, and other variables
	RAM [RamSize]byte
}

const (
	RamProgramStart      = 0x200
	RamSize              = 0x1000
	RamFontStart    byte = 0x0
)

func (m *Memory) Setup() {
	m.installFont()
}

func (m *Memory) LoadGame(romFilename string) {
	contents, err := ioutil.ReadFile(romFilename)
	if err != nil {
		panic(err)
	}

	for i, n := range contents {
		location := RamProgramStart + i
		if location > RamSize {
			panic("ROM was too large to fit into Chip-8 memory")
		}

		m.RAM[location] = n
	}
}

func (m *Memory) installFont() {
	// Chip-8's 4x5 pixel font set (0-F)
	// See http://devernay.free.fr/hacks/chip8/C8TECH10.HTM#2.4
	fontBytes := [80]byte{
		0xF0, 0x90, 0x90, 0x90, 0xF0, //0
		0x20, 0x60, 0x20, 0x20, 0x70, //1
		0xF0, 0x10, 0xF0, 0x80, 0xF0, //2
		0xF0, 0x10, 0xF0, 0x10, 0xF0, //3
		0x90, 0x90, 0xF0, 0x10, 0x10, //4
		0xF0, 0x80, 0xF0, 0x10, 0xF0, //5
		0xF0, 0x80, 0xF0, 0x90, 0xF0, //6
		0xF0, 0x10, 0x20, 0x40, 0x40, //7
		0xF0, 0x90, 0xF0, 0x90, 0xF0, //8
		0xF0, 0x90, 0xF0, 0x10, 0xF0, //9
		0xF0, 0x90, 0xF0, 0x90, 0x90, //A
		0xE0, 0x90, 0xE0, 0x90, 0xE0, //B
		0xF0, 0x80, 0x80, 0x80, 0xF0, //C
		0xE0, 0x90, 0x90, 0x90, 0xE0, //D
		0xF0, 0x80, 0xF0, 0x80, 0xF0, //E
		0xF0, 0x80, 0xF0, 0x80, 0x80, //F
	}

	for i, b := range fontBytes {
		m.RAM[RamFontStart+byte(i)] = b
	}
}
